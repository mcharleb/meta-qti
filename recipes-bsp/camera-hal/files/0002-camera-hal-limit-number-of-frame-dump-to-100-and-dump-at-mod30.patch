From e09f5636a7337376f69081530f262b85071c1a9a Mon Sep 17 00:00:00 2001
From: Suraj Swami <sswami@qti.qualcomm.com>
Date: Wed, 29 Apr 2015 11:13:06 -0700
Subject: [PATCH] camera hal limit number of frame dump to 100 and dump frame
 at mod30

---
 .../stack/mm-camera-test/src/mm_qcamera_preview.c  |   27 +++++++++++++++-----
 1 file changed, 21 insertions(+), 6 deletions(-)

diff --git a/QCamera2/stack/mm-camera-test/src/mm_qcamera_preview.c b/QCamera2/stack/mm-camera-test/src/mm_qcamera_preview.c
index 292bc7d..d83b8a1 100644
--- a/QCamera2/stack/mm-camera-test/src/mm_qcamera_preview.c
+++ b/QCamera2/stack/mm-camera-test/src/mm_qcamera_preview.c
@@ -33,6 +33,11 @@ IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 #include <sys/mman.h>
 #include <semaphore.h>
 
+#ifdef DUMP_PRV_IN_FILE
+	#define FRAME_MOD 30
+	#define MAX_NUM_FRAME_DUMP  (FRAME_MOD * 100)
+#endif 
+
 static void mm_app_metadata_notify_cb(mm_camera_super_buf_t *bufs,
                                      void *user_data)
 {
@@ -99,7 +104,11 @@ static void mm_app_metadata_notify_cb(mm_camera_super_buf_t *bufs,
 static void mm_app_preview_notify_cb(mm_camera_super_buf_t *bufs,
                                      void *user_data)
 {
-    int i = 0;
+
+#ifdef DUMP_PRV_IN_FILE
+    static int frame_count=0; 
+#endif 
+	  int i = 0;
     mm_camera_channel_t *channel = NULL;
     mm_camera_stream_t *p_stream = NULL;
     mm_camera_buf_def_t *frame = bufs->bufs[0];
@@ -139,11 +148,17 @@ static void mm_app_preview_notify_cb(mm_camera_super_buf_t *bufs,
         mm_app_overlay_display(pme, frame->fd);
     }
 #ifdef DUMP_PRV_IN_FILE
-    {
-      char file_name[64];
-      snprintf(file_name, sizeof(file_name), "P_C%d", pme->cam->camera_handle);
-      mm_app_dump_frame(frame, file_name, "yuv", frame->frame_idx);
-    }
+	if ( (frame_count < MAX_NUM_FRAME_DUMP ) &&  (frame_count % FRAME_MOD == 0) )
+	{
+		    char file_name[64];
+		    snprintf(file_name, sizeof(file_name), "P_C%d", pme->cam->camera_handle);
+			  mm_app_dump_frame(frame, file_name, "yuv", frame->frame_idx);
+	 }else if (frame_count >= MAX_NUM_FRAME_DUMP ) {
+				frame_count =0 ;
+				printf("\nStopping Preview after 100 frames\n");
+				exit(0);
+	 }
+	frame_count++;
 #endif
     if (pme->user_preview_cb) {
         CDBG_ERROR("[DBG] %s, user defined own preview cb. calling it...", __func__);
-- 
1.7.9.5

